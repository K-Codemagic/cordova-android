workflows:
  android-workflow:
    name: Android Cordova workflow
    environment:
      vars:
        KEYSTORE: Encrypted(Z0FBQUFBQmhLUE5tRWdlalFKRm5GaTVBZEQwcVhMaF93LUJIMTFWQnVfTl90NEF5RGY3T2VmMVJXUEFXTVpoNWt2S01xZGpETV8tSWNXUTk2R19WVHA2QkIwY2hSRlhUdWVHdnhsMmpKbjVRU2FUVHEtRjdfNGk5Z2hpaDdfa05mT2JIVVQ1eXB4VlFSQWViVE91ckVsbzlMdkMyMWYxOXJ2aXdmWExVWnNTbmw1N1RyVVh2MVljNE5YTVFQUS1rVVhJb0Mxenl3LUh2aHFNTTd5N1c4ZXE4SUtaVFY4Y1I5emJYeFQ2Y3ppX0p6ZF9XQ1lhd3E5VUl4dTBxakd5OHpLcDJuUzhkSnZBTW1fdnFUMkFBa29zSjhIWlhIVTBka212anNlTjNzS2Q2QS1KUmRiZ0FNdko4RjFMM3hqTFhRX1B3TGFyR3dYM2lESXhLNGlJZjlicWpDRkVTV2RpcDRQTHJZM3p5VVJuaGVjakNYdkd2RzhSbG1IblBOLXZHOW5kV3hlenM5cmluZVJjWWVHQk9mNEV3Ti02cFo2OVJKdzNnQnRITlpWV0NMNm1rbTlDQTNNX0RnRXFzZXJGbDFOa1pSd2M3cTBqak1xTGx3Nkt0cDdZdmFkR3JtWG82VUdhRUdTS2dhWWkyODhwWmo3aEdKV0RrQU5tdmF5V1JoVG83bzRBc3g2YU42dGpRRFcwYTRTOGQyaG9pelhYYmpqWkthT3ZMVHY1MElhTmxndC0zdU03MzNWMFk1eXZyelhJdEVubkRuRGU5NWdELW5vZVdWaVVmWkZyZzM0M2dLaUZVMWNmX0lBZkJDN2lzd2ZlUEJHM3lzWHpWd0hsVGdLZEdDMk9xRVNWekctZWhmNUhjRFNPTWhSSUdUV25sUDByOURPSjFFSDU2YlpQa0VqNXZDd1RHbGpibERBNFprNG1ZVVpkV3ZRTXJ4MTFqbDY4NmgycDFrZUZ6S2gzMk1FZFVaQmdLTnoyQ3FBRHpZMUdwaDUwX2lzSEVkNWw3UVpTQ1RVQmNwdXFqMS15Nm9FVk1md09mRndFUXVXV1ZhOGhWYnpvcEF3ZWhzb3REN3JQRlhROXFkSDhWSnprQUptWmJSR0R6bjRhRkZ5RFJaQWFaenR3bm45cnNQeE40U1JuU0gwV2tsek93RFU2bWxwVUFBQXNmUEItQ1QxVWRyOEtpSFMydk5mOWlSSmZCZzFGLUg4TTVpNW1pVGJFYUtlbTJhR29fMzlVdUZxUzlfTUJkODRKVGRoell1d01fa1JnQ1JILTdadHV0WkN2OWlxbjBtZUs1UVhoT0xad0h5QUdmR3hnbk50TC1fT3lJclNlTGg2Q1luTXNmS0J1eEtJcnV5Q080YXpHOGstSHBxWjg0cERxNWo5Q1Z3VzdJY29TdFNMX2tsQXlsNmVEcVY0ZGVVRzRBQkVhN0o2OW5TZ0g5M01Ka0M5TkdteU9uSFVhd0tFSUY5Ym9kUEZwRjc0NXBmcENlS0xacHZGMXc3ejJ3enNOX0tMd3BUZkNrSDRXV3cwNlFpckhuZDNGOERuakF6NjBKT00tYU52ejhBU182ajFyYUZMRUZ3QzJyTGlxemxiOGhBcmRJZmxBY29mZGxtbGplaERROUVpWDhXWUhoUE5zWWxrZVpkYjA1Uk4wekpwaGJYRE9Yck0wS0xYd0dyUnFJRE1qZVFwWUdZMS1zaW1nV3ZRMGFXNU5UWVdsNjUxTHM1aDJ3d0czN3BTVDJMSW9rNENmVTR1OGRzbUtDWXFzbTdBd1ZRTkJMZHhZcnJEejFnLWNtMkozQXhTSk1ORDRaYUwwa1gwLWd5ek1tdjBBaVJKSERfNFg3Ykp6Y0NEa2VwLTBGZHN2OUprVVZqMW1SSzFnd2QzTC1xLVdnc1pKUnlHLVNkQmp6Mk9iQVp5Ym5YNGNQQVBDN3RoQXcwcDFYRndZWHJUa0VadkxQczFnZXR1Wnp1cFlLOGRrX0VKajVtT2RyaDQ4bmtJbVdHOGhBWmwzNjRULVFCenBwNzh1dXZadlN2Ym1Xcmc4cWlLQlFmQ25IMExiX0lCT2xxd1RrbGZocjZFUTBTeHc1YXpfcGd3eHZVSDQySUxWNldBNFB6dGQyWXNPYl9ncmVwZ04ta3dsMTY4T3hnRjZyT1hwYXlLTEhBblUyZXdwWldlZUMyVWJFZVhnUjNNRE43Um02Nm14TnJuOXBjVlIzMVJNWGxyU0lQYTc5R1BYVDhQRGd2R080eDN4eHA4R3FPYTFIQW5ObTd1eWRqaHZDRzQwNGZwUzQ2ZVhYMm54VjZteFZpQTZ1TDVBdF9LZDZfMVVlakE4czhpdkRaWGUzV19BSkU1T2piZnZpUzRKZGNXUHI2anAwUDY0MU1zWmxST24talFXb3VWbHVzVy1BajI0enc4Um1Pd0xQUC1kRG1sZzBzU3pndDVtM3RUSk5Jb3NiZ3ZXNnZhY2UwVjBzWThCWmswLTF2NFJ1TFdBbkxYUmctNEIwdkYxamVxUnJfdXpVTTBPRGxPUjdScktFZWFuY0VYZjZCMjZSZU9ZUjcyclhHQ01JbkE2TUFyQWxBU1VINWZsaGdjdXFscnBGOHlZem9oeUktTWtEbVZsNkFIZzVvWVp3NWJKdmN5MGFxZzh0QThWYmxGSllfY0tkQzNGV1UxY19sa0d5NmdhWVJvcTltc0xsdHJSS19Pel9MRzFjU2xRV2FSY00zZUswYjNOMlByZXYzTzY4b0RzRmFDSzlYRlZoQlhkNVpFTGdYbXhrMno3WkUzTEVfM04zbFpOYnhoVC0tcnRFaFMtSzR2eS14VHhSSUR3ZXdEYTF6NHNrdTNTQ0RNYVZReXZUUjc2RXdzMzZNMVVzNDBrNER3RTVCdGY4UGdpdjliWEpvNTJ2MnU5WUNyTG9uc1dLR3c1dVBUVzBBQ1NxVlJobG9wZFh6TnIzcmJmVk5mdmNiZnppZUpvTWxGZ2J0UTk2R1pOdHBSRTNLZXhxTEhndDRvWkJRRmdSNm9jdDk0NkNmYmNZQk1EWEJtSHE5YTdtUXhVdGR3eExkcjh6T0VVU2RHeFA1VHROUElnOVptVm90eVJBUTU3ZmJBWURkMkpzanVzeFBnT2hpSHptc25JZ0dVVlpNSFQtYmNoWG5ELXJNb2pKUmdLb01IUS1UZkM5TGlMYXV5MlBDSk9JWjJfX2E0eUd6ak5zbzY3WWliN3lBdXNCekwwN2lEQ0x6S2dhN0RJak9ocVVpdm50OGcxcGhkSGp6QlRXZkJPRVV1dFZfRkpKTjd3cV9xQ1hNT2NjU2Y2X2N6VjNsU0ZTVVhVZ0xvaVhEdEhkSDUwNnAwR0xaUnRLSmZXazZxMDJfcnA4U3VaVHY1S3lQamVGS243R3lsQXJ6SWh6ZVQ2YmFPOGhaaTQ5LXQyVFBxeTJzNnE3UmtPeFF6V1Q0WkJJMXJhQjU1LW9JQ2s5YUZRUzlSMHZUeW1kU1Q3czNIVDhxWlNUMEpnTWl6eDFpWEdObUZtLVc1cElRdzA3d0lFM2pzS21YS2xnNXlVaEpibVA5UVppMFk5NVB6dDlweF9xWExhR0Jab2lkWGtMT2dCSDJKNTF6RDRzbUNkVUxfa2lVaExtaXJZT3hqZUhSbjhjdFQ0TTBBbmJ2NVc0b3ZraGpic0tzVkNsX01xWFB2eVlZemtwNEVSSFdfbzFPbDYwZU44cEVpcTB6MWxIdnQweV9wZElSVko3czMxRmNpcUJVNi1NWDFSLU5jRXdxRl82bjZlYmt3WThQdkFldGMyUjY2VDFhOTZZSDU3SERyRC1fb0swUXV5eTBndEVYZWItd2o2WFlfd2V3bk5hMlVQSjFxSXlDZko0c05CSUhhbFNDV25maFpiR2dYTHNSRFg4czFkRFZTd19OcmJUR1lQT0NHOXd0dGRSQ1hzN3VveFJnd0JMQVgtb21NU1VVQWZqVldVbUgtZjlFUnU3d2pJdE5hd3k1dTRpNzRzSHoybFpfY002Y1NTWjN5c2RaMkFPM05rSFpxYWtOT1BMd3dTWWk0aDJfVkFqZFJGUXVtRENFYTVxVHppNWE2M3NOcnp3a2xHQWdwWkd4dEVQTHF4SW5jR1JPTFJxZ0pYWXZSd28wNEZ2RERiOHpoQ3dYZVoxcUNhUC1pNWZzYnh1emtQQnFBUmQtTzNTaGwwVE91cUJ1OGxZamk0MDVKRnNrVlBwdWZRSHZUeEdnYWctc2hmRDlYakxsYmp6TEplXzZ3c081Y3RiMW1qS01GZkNKRDd0QjV3YUM0eFUzM0t1dFpDVEg1R2pITHlHbl8zMTdrZzJ6cnhvdFVHelRxY2YyWjhMVm50OHpLMHZ3NVl3YlFHTlZQYmVBQ05OTzhMaWVuaFl1NmE3aFJGYzdLSlBkZlpyTEYxbHhxWXNZdFJwUnpFTkNEMUhSel9ERXhsYU1PN2R0ZExuZnYzVGNsWlpjZ3p3MHVSd2pneWxoX2lFQUJ6MGpFNVZmd1Z5NDBMTHpkU1JSNXgxUXlHZjQ5SmhqZ05nQUJWVVpOZzNOVXFqSFRuMTRld3NtNWNJZWN3clZqRzVBa3VrNW9McENfcFBUSy1SQUJOOXFQZXV3TXB3dEJaaElCeGZxM1MtQl9zQ0FROEFXRnhSa3NSYnhaN1B3bF9jOHYybzFwS0toaVExMXFzQXUtdjVPOHlEcF9JV29EMnNGMUU4R1F0Q2ZpVDNIY0pwR0xiUFg3czRBczk4SnVRZEpWM1FhWUlXSmZxUTAwTUdteEZMZWZhUUNTdlAxbF8xTkQ1cDhFamxqNzlnMW15VFhidVpBOGJsMnM2UUttS2NueFllWjR2U1NjQXI1dXdKUnVXU180bmUtRFJvZlZJaGZSZzU1anNfQnZodnRiblJOcjh6NEpJZnBVTURFNHR5X2JFYlFQUS1Sa0Y4TlIzYnY4Xy11bTRoUnZwWUw2Nnllc0VxQWNEYWpuZEp5YTY5WXVLSl9NSFFMY3lJZ3NIU2llT3RIMWhmOFNIQ2dwSnRDV2VWNlVYZm5sVWxLLTl1dFVzY3h0cGhXbk56OU1MQ3h0RlRmT2VXaDJoaV9PMUZaSUxadnlVcWtZVnQtblFrTmxxdTVOaXBWVlFTSFRIaDJ6QXFNalNnYXhSS0VMU1EzbG1lNHpHQV84S0VYUExtd1FNRGhNZy1CdlEycUVPT3MzQW5sT2NmTjl1aGR0cDNpUmg3SUR6TDFHVUlYeEVuc2xuWUVyTU5HN2lIM2FqUlVLN25ueEozQkFWWWlkaFQ2LV9HcTNOdUNXdXY0ZWRRSE1HeU5FZDd4RDlISUJoeGZ4NFVuVkdoY19IRVY4QzlsM2hRWDljPQ==)
        KEYSTORE_PATH: '/tmp/keystore.keystore'
        KEYSTORE_PASSWORD: Encrypted(Z0FBQUFBQmhLUE8xRlJhZ0dmcjRXaDRJMElXYjJrZUhUY0luSmZwRW8xYWRaM1JmbkJ0Yy1zUXpiXzN6c3diSDBMNEpnT25GU0dCTHZMc2doQlVqLWd1ckYyclV4RkhFUkE9PQ==) # <-- Put your encrypted keystore password here
        KEY_ALIAS_PASSWORD: Encrypted(Z0FBQUFBQmhLUE8xRlJhZ0dmcjRXaDRJMElXYjJrZUhUY0luSmZwRW8xYWRaM1JmbkJ0Yy1zUXpiXzN6c3diSDBMNEpnT25GU0dCTHZMc2doQlVqLWd1ckYyclV4RkhFUkE9PQ==)
        KEY_ALIAS: Encrypted(Z0FBQUFBQmhLUE8xRlJhZ0dmcjRXaDRJMElXYjJrZUhUY0luSmZwRW8xYWRaM1JmbkJ0Yy1zUXpiXzN6c3diSDBMNEpnT25GU0dCTHZMc2doQlVqLWd1ckYyclV4RkhFUkE9PQ==)
      xcode: 12.4
      node: 12
      npm: 6
    cache:
      cache_paths:
        - $FCI_BUILD_DIR/node_modules
    scripts:
      - name: Install dependencies
        script: |
          npm install
          npm ci
          cvm install 9.0.0
          cvm use 9.0.0                  
      - name: Add Android platform
        script: |
          set -x
          cordova platform remove android --nosave
          cordova platform add android --confirm --no-interactive --noresources          
      - name: Build Android
        script: |
          set -x
          set -e
          cordova build android --release --no-interactive --prod --device
          echo $KEYSTORE | base64 --decode > $KEYSTORE_PATH
          UNSIGNED_APK_PATH=$(find platforms/android/app/build/outputs -name "*.apk" | head -1)
          jarsigner -sigalg SHA1withRSA -digestalg SHA1 -keystore "${KEYSTORE_PATH}" -storepass "${KEYSTORE_PASSWORD}" -keypass "${KEY_ALIAS_PASSWORD}" "${UNSIGNED_APK_PATH}" "${KEY_ALIAS}"
          mv $UNSIGNED_APK_PATH $(echo $UNSIGNED_APK_PATH | sed 's/-unsigned//')          
    artifacts:
      - platforms/android/app/build/outputs/**/*.apk
      - platforms/android/app/build/outputs/**/mapping.txt
    publishing:
      # See the following link for details about email publishing - https://docs.codemagic.io/publishing-yaml/distribution/#email
      email:
        recipients:
          - kalgi@nevercode.io
        notify:
          success: true     # To receive a notification when a build succeeds
          failure: false    # To not receive a notification when a build fails
